From 5856cc6a2f1cfac5058e4a631239a6e63e8d0446 Mon Sep 17 00:00:00 2001
From: Axel Huebl <axel.huebl@plasma.ninja>
Date: Fri, 4 Jun 2021 12:30:03 -0700
Subject: [PATCH] Compress Blosc: Fix MSVC Build

Generalize packed data attributes.
---
 source/adios2/operator/compress/CompressBlosc.h | 16 ++++++++++++++--
 1 file changed, 14 insertions(+), 2 deletions(-)

diff --git a/source/adios2/operator/compress/CompressBlosc.h b/source/adios2/operator/compress/CompressBlosc.h
index 9251b91d1f..f472de4862 100644
--- a/source/adios2/operator/compress/CompressBlosc.h
+++ b/source/adios2/operator/compress/CompressBlosc.h
@@ -17,6 +17,14 @@
 
 #include "adios2/core/Operator.h"
 
+#if defined(_MSC_VER)
+#define ADIOS2_CLASS_PACKED(name) __pragma(pack(push, 1)) class name
+#define ADIOS2_CLASS_PACKED_SUFFIX __pragma(pack(pop))
+#else
+#define ADIOS2_CLASS_PACKED(name) class __attribute__((packed)) name
+#define ADIOS2_CLASS_PACKED_SUFFIX
+#endif
+
 namespace adios2
 {
 namespace core
@@ -77,7 +85,7 @@ class CompressBlosc : public Operator
                                void *dataOut, const size_t sizeOut,
                                Params &info) const;
 
-    class __attribute__((packed)) DataHeader
+    ADIOS2_CLASS_PACKED(DataHeader)
     {
         /** compatible to the first 4 byte of blosc header
          *
@@ -106,7 +114,8 @@ class CompressBlosc : public Operator
         uint32_t GetNumChunks() const { return numberOfChunks; }
 
         bool IsChunked() const { return format == 0; }
-    };
+    }
+    ADIOS2_CLASS_PACKED_SUFFIX;
 
     static const std::map<std::string, uint32_t> m_Shuffles;
     static const std::set<std::string> m_Compressors;
@@ -116,4 +125,7 @@ class CompressBlosc : public Operator
 } // end namespace core
 } // end namespace adios2
 
+#undef ADIOS2_CLASS_PACKED
+#undef ADIOS2_CLASS_PACKED_SUFFIX
+
 #endif /* ADIOS2_OPERATOR_COMPRESS_COMPRESSBLOSC_H_ */
